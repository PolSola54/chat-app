<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <title>Xat amb Sales</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    .my-message {
      text-align: right;
      color: blue;
    }
    .other-message {
      text-align: left;
      color: green;
    }
    #chat {
      list-style-type: none;
      padding: 0;
      margin: 1rem 0;
    }
    #chat li {
      padding: 4px;
    }
  </style>
</head>
<body>
  <h1>Xat amb Sales</h1>

  <!-- Nom d'usuari -->
  <div id="nameForm">
    <label>Nom d'usuari:</label>
    <input type="text" id="username" placeholder="Ex: Pol" />
    <button onclick="setName()">Següent</button>
  </div>

  <!-- Selecció de sala -->
  <div id="roomForm" style="display:none;">
    <label>Nom de la sala:</label>
    <input type="text" id="room" placeholder="Ex: general" />
    <button onclick="joinRoom()">Entrar a la sala</button>
  </div>

  <!-- Xat -->
  <div id="chatBox" style="display:none;">
    <h2 id="roomTitle"></h2>
    <input type="text" id="msg" placeholder="Escriu un missatge..." />
    <button onclick="sendMsg()">Envia</button>
    <button onclick="leaveRoom()">Sortir de la sala</button>
    <ul id="chat"></ul>
  </div>

  <script>
    const socket = new WebSocket(`ws://${location.host}`);
    let username = '';
    let room = '';

    // Establir nom
    function setName() {
      username = document.getElementById('username').value.trim();
      if (!username) return;
      socket.send(JSON.stringify({ type: 'setName', username }));
      document.getElementById('nameForm').style.display = 'none';
      document.getElementById('roomForm').style.display = 'block';
    }

    // Entrar a la sala
    function joinRoom() {
      room = document.getElementById('room').value.trim().toLowerCase();
      if (!room) return;
      socket.send(JSON.stringify({ type: 'joinRoom', room }));
      document.getElementById('roomForm').style.display = 'none';
      document.getElementById('chatBox').style.display = 'block';
      document.getElementById('roomTitle').innerText = `Sala: ${room}`;
      document.getElementById('chat').innerHTML = ''; // Neteja el xat
    }

    // Enviar missatge
    function sendMsg() {
      const input = document.getElementById('msg');
      const text = input.value.trim();
      if (!text) return;

      const li = document.createElement('li');
      li.textContent = text;
      li.classList.add('my-message');
      document.getElementById('chat').appendChild(li);

      socket.send(JSON.stringify({ type: 'message', text }));
      input.value = '';
    }

    // Sortir de la sala
    function leaveRoom() {
      room = '';
      document.getElementById('chatBox').style.display = 'none';
      document.getElementById('roomForm').style.display = 'block';
    }

    // Tecla enter funcional
    document.getElementById('username').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') setName();
    });

    document.getElementById('room').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') joinRoom();
    });

    document.getElementById('msg').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMsg();
    });

    // Rebre missatge
    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.username === username) return;

      const li = document.createElement('li');
      li.textContent = `${data.username}: ${data.text}`;
      li.classList.add('other-message');
      document.getElementById('chat').appendChild(li);
    };
  </script>
</body>
</html>
